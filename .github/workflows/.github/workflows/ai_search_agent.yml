name: AI Search Agent (Public OSINT Sweep)

on:
  schedule:
    - cron: "30 10 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: mk
        run: |
          set -euo pipefail
          # A scope is any folder that has: data/sources/sources_whitelist.csv
          mapfile -t scopes < <(find administrations case_threads -type f -path "*/data/sources/sources_whitelist.csv" 2>/dev/null | sed 's|/data/sources/sources_whitelist.csv$||' | sort || true)
          if [ ${#scopes[@]} -eq 0 ]; then
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          json='{"include":['
          first=1
          for s in "${scopes[@]}"; do
            if [ $first -eq 0 ]; then json+=','; fi
            first=0
            json+='{"base":"'"$s"'"}'
          done
          json+=']}'
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  sweep:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas beautifulsoup4 feedparser requests
      - name: Run AI Search Agent (scope)
        run: |
          python scripts/search_agent.py --base "${{ matrix.base }}"
          python scripts/build_ai_agent_summary.py --base "${{ matrix.base }}"
      - name: Commit updates (scope)
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            ${{ matrix.base }}/data/master/
            ${{ matrix.base }}/data/unverified/
            ${{ matrix.base }}/data/logs/ai_agent/
            ${{ matrix.base }}/data/summary/
          message: "chore(ai-agent): update scope ${{ matrix.base }}"
